#!/bin/sh
#
# This script generate some valid Slackware packages
#
#
# Some variables.
#
OLDCWD=`pwd`

CWD=`pwd`
PACKAGE=@PACKAGE@.tgz
SLCK=$CWD/slack
PREFIX=@prefix@
export PKG=$CWD/slktmp
TMPBUILD=$CWD/tmpbuild

#
# Create post-install shell script.
#
do_doinst() {
  (mkdir install 
   cd install
  cat > doinst.sh <<EOF
if [ -d @XINE_SKINDIR@/default ]; then
  echo "Removing old <default> skin, <xinetic> is the new default skin."
  rm -rf @XINE_SKINDIR@/default && \
  ln -s @XINE_SKINDIR@/xinetic @XINE_SKINDIR@/default;
fi

# Icons
if test ! -d /usr/share/icons; then 
  @INSTALL@ -m 755 -o 0 -g 0 -d /usr/share/icons
fi
@INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.xpm /usr/share/icons/xine.xpm
if test ! -d /usr/share/pixmaps; then 
  @INSTALL@ -m 755 -o 0 -g 0 -d /usr/share/pixmaps
fi
@INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.xpm /usr/share/pixmaps/xine.xpm
if test -d /etc/X11/wmconfig; then 
  @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.wmconfig /etc/X11/wmconfig/xine
fi
if test -d /etc/X11/applnk; then
  if test ! -d /etc/X11/applnk/Multimedia; then 
    @INSTALL@ -m 755 -o 0 -g 0 -d /etc/X11/applnk/Multimedia
  fi
  @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /etc/X11/applnk/Multimedia/xine.desktop
fi
# End Icons
# Gnome
if test -d /opt/gnome; then
  if test ! -d /opt/gnome/share/pixmaps; then 
    @INSTALL@ -m 755 -o 0 -g 0 -d /opt/gnome/share/pixmaps
  fi
  @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.xpm /opt/gnome/share/pixmaps/xine.xpm
  if test -d /opt/gnome/share/gnome/apps/Multimedia; then
    @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /opt/gnome/share/gnome/apps/Multimedia/xine.desktop
  else
    @INSTALL@ -m 755 -o 0 -g 0 -d /opt/gnome/share/gnome/apps/Multimedia
    @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /opt/gnome/share/gnome/apps/Multimedia/xine.desktop
  fi
else
  if test -d /usr/share/gnome/apps; then
    if test -d /usr/share/gnome/apps/Multimedia; then
      @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /usr/share/gnome/apps/Multimedia/xine.desktop
    else
      @INSTALL@ -m 755 -o 0 -g 0 -d /usr/share/gnome/apps/Multimedia
      @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /usr/share/gnome/apps/Multimedia/xine.desktop
    fi
  fi
fi
# End Gnome
# Kde2
if test -d /opt/kde2; then
  DIR_HI=/opt/kde2/share/icons/hicolor
  DIR_LO=/opt/kde2/share/icons/locolor
  HIRES='48x48 32x32 22x22'
  LORES='32x32 22x22 16x16'
  for hires in $$HIRES; do
    @INSTALL@ -m 755 -o 0 -g 0 -d $DIR_HI/$hires/apps
    @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine_$hires.png $DIR_HI/$hires/apps/xine.png
  done
  for lores in $$LORES; do
    @INSTALL@ -m 755 -o 0 -g 0 -d $DIR_LO/$lores/apps
    @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine_$lores.png $DIR_LO/$lores/apps/xine.png
  done
  if test ! -d /opt/kde2/share/applnk/Multimedia; then 
    @INSTALL@ -m 755 -o 0 -g 0 -d /opt/kde2/share/applnk/Multimedia
  fi
  @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /opt/kde2/share/applnk/Multimedia/xine.desktop
else
  if test -d /usr/share/applnk/Multimedia; then
    if test ! -d /usr/share/applnk/Multimedia; then 
      @INSTALL@ -m 755 -o 0 -g 0 -d /usr/share/applnk/Multimedia
    fi
    @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /usr/share/applnk/Multimedia/xine.desktop
  fi
fi
# End Kde2
# Kde
if test -d /opt/kde; then
  if test ! -d /opt/kde/share/icons; then 
    @INSTALL@ -m 755 -o 0 -g 0 -d /opt/kde/share/icons
  fi
  if test ! -d /opt/kde/share/applnk/Multimedia; then 
    @INSTALL@ -m 755 -o 0 -g 0 -d /opt/kde/share/applnk/Multimedia
  fi
  @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.xpm /opt/kde/share/icons/xine.xpm
  @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /opt/kde/share/applnk/Multimedia/xine.desktop
else
  if test -d /usr/share/applnk/Multimedia; then 
    @INSTALL@ -m 644 -o 0 -g 0 @XINE_DESKTOPDIR@/xine.desktop /usr/share/applnk/Multimedia/xine.desktop
  fi
fi

/sbin/ldconfig
EOF
)
}

#
# Create package description for pkgtool.
#
do_descr() {
cat > package_descriptions << EOF
@PACKAGE@: @PACKAGE@ @SPEC_VERSION@.
@PACKAGE@:
@PACKAGE@: xine is a free gpl-licensed video player for unix-like systems.
@PACKAGE@: We support mpeg-2 and mpeg-1 system (audio + video multiplexed) streams,
@PACKAGE@: eventually mpeg-4 and other formats might be added.

@PACKAGE@: xine plays the video and audio data of mpeg-2 videos and synchronizes
@PACKAGE@: the playback of both. Depending on the properties of the mpeg stream,
@PACKAGE@: playback will need more or less processor power, 100% frame rate
@PACKAGE@: has been seen on a 400 MHz P II system.
EOF
}

#
# Building binaries process, then install and move package in right place
#
do_build() {
  cd $CWD
  rm -rf $TMPBUILD
  mkdir -p $TMPBUILD
  cd $TMPBUILD && tar -xzf $CWD/@TAR_NAME@.tar.gz
  cd @TAR_NAME@
  DIE=1
  cp ./configure ./configure.orig
  sed -e 's/xine_skin_dir=/xine_skin_dir=$PKG/;s/xine_desktop_dir=/xine_desktop_dir=$PKG/' configure.orig > ./configure
  ./configure --prefix=$PREFIX && make && make install-strip prefix=$PKG/$PREFIX && \
  cd $PKG && \
  do_doinst && \
  echo "n" | makepkg $PACKAGE && \
  mv $PACKAGE $SLCK && \
  cd $SLCK && DIE=0
  do_descr
}

#
# Cleaning building directory
#
do_clean() {
  rm -rf $TMPBUILD
  rm -f $PACKAGE package_descriptions
  rm -rf $PKG
  cd $CWD
}

#
# Build for PPro
# 
build_pentiumpro() {
  echo "*****************************************************"
  echo
  echo "building slack for @PACKAGE@ @VERSION@"
  echo 
  echo "current architecture:pentiumpro"
  echo "slackware package will be copied to ./slack directory"
  echo
  echo "*****************************************************"
  rm -rf $PKG
  export XINE_BUILD=i686-pc-linux-gnu
  do_build
  if test "$DIE" -eq 0; then 
    tar -czvf @PACKAGE@-@VERSION@-i686.tar.gz $PACKAGE package_descriptions
  fi
  do_clean
}

#
# Build for Pentium
#
build_pentium() {
  echo "*****************************************************"
  echo
  echo "building slack for @PACKAGE@ @VERSION@"
  echo 
  echo "current architecture:pentium"
  echo "slackware package will be copied to ./slack directory"
  echo
  echo "*****************************************************"
  rm -rf $PKG
  export XINE_BUILD=i586-pc-linux-gnu
  do_build
  if test "$DIE" -eq 0; then 
    tar -czvf @PACKAGE@-@VERSION@-i586.tar.gz $PACKAGE package_descriptions
  fi
  do_clean
}

#
# Build for K6
#
build_k6() {
  echo "*****************************************************"
  echo
  echo "building slack for @PACKAGE@ @VERSION@"
  echo 
  echo "current architecture:k6"
  echo "slackware package will be copied to ./slack directory"
  echo
  echo "*****************************************************"
  rm -rf $PKG
  export XINE_BUILD=k6-pc-linux-gnu
  do_build
  if test "$DIE" -eq 0; then 
    tar -czvf @PACKAGE@-@VERSION@-k6.tar.gz $PACKAGE package_descriptions
  fi
  do_clean
}

#
# Build for K7
#
build_k7() {
  echo "*****************************************************"
  echo
  echo "building slack for @PACKAGE@ @VERSION@"
  echo 
  echo "current architecture:k7"
  echo "slackware package will be copied to ./slack directory"
  echo
  echo "*****************************************************"
  rm -rf $PKG
  export XINE_BUILD=athlon-pc-linux-gnu
  do_build
  if test "$DIE" -eq 0; then 
    tar -czvf @PACKAGE@-@VERSION@-k7.tar.gz $PACKAGE package_descriptions
  fi
  do_clean
}

#
# Main function
#
main() {
  rm -rf $SLCK
  mkdir -p $SLCK
  rm -f config.cache && ./cvscompile.sh && make dist
  build_pentiumpro
  build_pentium
  build_k6
  build_k7
  mv -f $CWD/@TAR_NAME@.tar.gz $SLCK
}


#
# Handle arguments if available.
#
build_arch() {
      rm -rf $SLCK
      mkdir -p $SLCK
      rm -f config.cache && ./cvscompile.sh && make dist
      $barch
      mv -f $CWD/@TAR_NAME@.tar.gz $SLCK
}
case "$1" in
    pentiumpro | ppro | i686 | 686)
      barch=build_pentiumpro
      build_arch
    ;;
    pentium | i586 | 586)
      barch=build_pentium
      build_arch
    ;;
    k6)
      barch=build_k6
      build_arch
    ;;
    k7 | athlon)
      barch=build_k7
      build_arch
    ;;
    *)
      main
    ;;
esac

cd $OLDCWD
